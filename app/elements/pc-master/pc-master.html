<link rel="import" href="..\..\bower_components/polymer/polymer.html">

<dom-module id="pc-master">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    
    <iron-ajax url="../../data/meta-data.json" last-response="{{metaData}}" auto></iron-ajax>
    <!--<iron-ajax url="../../data/grid-data.json" last-response="{{gridItems}}" auto></iron-ajax>-->
    <pc-ajax url="../../data/drop-down-config.json" response="{{dropDownConfig}}" auto></pc-ajax>
    
    <pc-data data="{{gridItems}}" location="https://polycafe.firebaseio.com/customers"></pc-data>
    
    <paper-dialog id="frmDialog">
        <pc-form-main id="frmMain" form-event="{{formEvent}}" drop-down-config="{{dropDownConfig}}" meta-data="{{metaData}}" form-data="{{formData}}"></pc-form-main>
    </paper-dialog>
    
    <paper-icon-button icon="add" style="float:right" on-click="addNew"></paper-icon-button>
    <pc-grid-main meta-data="{{metaData}}" grid-items="{{gridItems}}" selected-item="{{selectedItem}}" drop-down-config="{{dropDownConfig}}"></pc-grid-main>
    
  </template>
  <script> 
  (function() {
    'use strict';
  
    Polymer({
      is: 'pc-master',

      properties: {
        selectedItem: {
           observer: '_selectedItemChanged'
        },
        formData: { },
        formEvent: { observer: '_handleFormEvent'},
        gridItems: { observer: '_handleGridItemsChange'},
      },
      _handleGridItemsChange: function(y) {
        console.log(y);
      },
      guid: function() {
        function s4() {
          return Math.floor((1 + Math.random()) * 0x10000)
            .toString(16)
            .substring(1);
        }
        return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
          s4() + '-' + s4() + s4() + s4();
      },
      addNew: function() {
        this.formData = {};
        this.$.frmDialog.open();
      },
      addItem: function(x) {
        if(x.Id)
        {
          var ind = _.findIndex(this.gridItems, 'Id', x.Id);
          var itm = this.gridItems[ind];
          _.assign(itm, x);
        }
        else
        {
          x.Id = this.guid();
          this.push('gridItems', x);
        }
        this.fire('iron-signal', {name: 'updategrid', data: this.gridItems });
        this.$.frmDialog.close();
      },
      ready: function() {
        var parent = this;
        this.$.frmMain.addEventListener('add', function(x) {
            parent.addItem(x.detail);
        });
      },
      _handleFormEvent: function(x) {
        if(x === 'Cancel')
        {
          this.selectedItem = null;
          this.formEvent = '';
          this.$.frmDialog.close();
        }
      },
      _selectedItemChanged: function(x) {
        this.formData = x;
        this.$.frmDialog.open();
      }
    });
  })();
  </script>
</dom-module>
